name: Create Cluster

on: pull_request

jobs:
  create-cluster:
    runs-on: ubuntu-latest
    steps:
      - name: Get repo
        uses: actions/checkout@v4
      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: "kind"
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Get kubeconfig
        run: kind get kubeconfig > kubeconfig
      - name: Terraform Init
        run: terraform init
      - name: Terraform Apply
        run: terraform apply --auto-approve
      - name: Wait for Grafana Deployment
        run: kubectl rollout status deployment/grafana -n grafana
      - name: Get Grafana Deployment Logs
        run: kubectl logs -n grafana --selector="app=grafana"
      - name: Check Grafana Namespace
        run: kubectl get all -n grafana
      - name: Check service API health
        run: | 
          # Get nodePort
          nodePort=$(kubectl get service -n grafana -o go-template --template='{{range .items}}{{range .spec.ports}}{{if .nodePort}}{{.nodePort}}{{"\\n"}}{{end}}{{end}}{{end}}')
          echo "nodePort is: ${nodePort}"
          # Check Grafana Health API Endpoint
          curl "admin:admin@localhost:${nodePort}/api/health"
          # Check Grafana Organization API Endpoint
          curl "admin:admin@localhost:${nodePort}/api/org"